<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* Ensure 100% height percentages actually work */
      html, body {
        height: 100%;
        margin: 0;
      }
      body { margin: 0; }

      /* Fill the iframe viewport */
      .container {
        position: relative;
        width: 100vw;   /* fill iframe width */
        height: 100vh;  /* fill iframe height (fallback) */
        overflow: hidden;
      }
      .video {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container" id="container">
      <div class="video" id="player"></div>
    </div>

    <script>
      // --- Keep container exactly the size of the iframe viewport ---
      const containerEl = document.getElementById('container');
      function sizeToViewport() {
        // Use real viewport to avoid mobile 100vh issues
        containerEl.style.width  = window.innerWidth + 'px';
        containerEl.style.height = window.innerHeight + 'px';
      }
      sizeToViewport();
      window.addEventListener('resize', sizeToViewport);
      window.addEventListener('orientationchange', sizeToViewport);

      // --- RN bridge (unchanged) ---
      function sendMessageToRN(msg) {
        if (window.ReactNativeWebView?.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify(msg));
        }
      }

      const parsedUrl = new URL(window.location.href);
      const UrlQueryData = parsedUrl.searchParams.get('data') || '{}';
      const {
        end, list, color, start, rel_s, loop_s, listType, playerLang, playlist,
        videoId_s, controls_s, cc_lang_pref_s, contentScale_s, allowWebViewZoom,
        modestbranding_s, iv_load_policy, preventFullScreen_s, showClosedCaptions_s,
      } = JSON.parse(UrlQueryData);

      // Viewport meta (slightly tightened)
      let metaString = '';
      if (contentScale_s) metaString += `initial-scale=${contentScale_s}, `;
      if (!allowWebViewZoom) metaString += `maximum-scale=${contentScale_s}`;
      const viewport = document.querySelector('meta[name=viewport]');
      if (viewport) viewport.setAttribute('content', 'width=device-width, ' + metaString);

      // YouTube IFrame API
      const randomPlayerId = 'player' + Date.now();
      document.getElementById('player').id = randomPlayerId;

      var tag = document.createElement('script');
      tag.src = 'https://www.youtube.com/iframe_api';
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player(randomPlayerId, {
          // Critical: make the iframe itself flexible
          width: '100%',
          height: '100%',
          videoId: videoId_s,
          playerVars: {
            end, rel: rel_s, list, color, loop: loop_s, start,
            playsinline: 1, hl: playerLang, playlist, listType,
            controls: controls_s, fs: preventFullScreen_s, cc_lang_pref: cc_lang_pref_s,
            iv_load_policy, modestbranding: modestbranding_s, cc_load_policy: showClosedCaptions_s,
          },
          events: {
            onReady: onPlayerReady,
            onError: onPlayerError,
            onStateChange: onPlayerStateChange,
            onPlaybackRateChange: onPlaybackRateChange,
            onPlaybackQualityChange: onPlaybackQualityChange,
          },
        });
      }

      function onPlayerError(event) { sendMessageToRN({eventType:'playerError', data:event.data}); }
      function onPlaybackRateChange(event) { sendMessageToRN({eventType:'playbackRateChange', data:event.data}); }
      function onPlaybackQualityChange(event) { sendMessageToRN({eventType:'playerQualityChange', data:event.data}); }
      function onPlayerReady() { sendMessageToRN({eventType:'playerReady'}); }
      function onPlayerStateChange(event) { sendMessageToRN({eventType:'playerStateChange', data:event.data}); }

      // Fullscreen listeners (unchanged)
      var isFullScreen = false;
      function onFullScreenChange() {
        isFullScreen =
          document.fullscreenElement ||
          document.msFullscreenElement ||
          document.mozFullScreenElement ||
          document.webkitFullscreenElement;
        sendMessageToRN({ eventType:'fullScreenChange', data:Boolean(isFullScreen) });
      }
      document.addEventListener('fullscreenchange', onFullScreenChange);
      document.addEventListener('msfullscreenchange', onFullScreenChange);
      document.addEventListener('mozfullscreenchange', onFullScreenChange);
      document.addEventListener('webkitfullscreenchange', onFullScreenChange);

      // Message bridge (unchanged)
      window.addEventListener('message', function (event) {
        const { data } = event;
        try {
          const { eventName, meta } = JSON.parse(data);
          switch (eventName) {
            case 'playVideo': player.playVideo(); break;
            case 'pauseVideo': player.pauseVideo(); break;
            case 'muteVideo': player.mute(); break;
            case 'unMuteVideo': player.unMute(); break;
            case 'setVolume': player.setVolume(meta.volume); break;
            case 'setPlaybackRate': player.setPlaybackRate(meta.playbackRate); break;
          }
        } catch (error) {
          console.error('Error parsing data', event, error);
        }
      });
    </script>
  </body>
</html>